<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign In â€” FridgeMate</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light d-flex align-items-center" style="height: 100vh;">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <div class="card shadow-sm">
          <div class="card-body p-4">
            <h2 class="fw-bold mb-3 text-center">Sign in to FridgeMate</h2>
            <p class="text-muted text-center mb-4">Welcome back! Access your shared fridges.</p>
            <div id="loadingDiv" class="text-center" style="display: none;">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Processing authentication...</p>
            </div>
            <div id="signinDiv">
              <div class="d-grid mb-3">
                <button id="signinBtn" class="btn btn-primary btn-lg">Sign In</button>
              </div>
              <p class="text-center small mt-3">Don't have an account?
                <a href="/login.html">Sign up</a>
              </p>
            </div>
            <div id="errorDiv" class="alert alert-danger" style="display: none;"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
<script type="module">
  import { createAuth0Client } from "https://cdn.jsdelivr.net/npm/@auth0/auth0-spa-js@2/dist/auth0-spa-js.production.esm.js";
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  
  const loadingDiv = document.getElementById("loadingDiv");
  const signinDiv = document.getElementById("signinDiv");
  const errorDiv = document.getElementById("errorDiv");

  function showError(message) {
    errorDiv.textContent = message;
    errorDiv.style.display = "block";
    loadingDiv.style.display = "none";
    signinDiv.style.display = "block";
    console.error(message);
  }

  try {
    // Initialize Auth0 - SAME CONFIG AS SIGNUP
    const auth0Client = await createAuth0Client({
      domain: "dev-smvnj34hnxrphpec.eu.auth0.com",
      clientId: "pVYadmwHRgmdLYzcCOIhxVYuYT7zQqX3",
      authorizationParams: {
        redirect_uri: window.location.origin + window.location.pathname
      }
    });

    console.log("Auth0 client initialized");
    console.log("Redirect URI:", window.location.origin + window.location.pathname);

    // Firebase config - SAME AS SIGNUP
    const firebaseConfig = {
      apiKey: "AIzaSyAp7TebsGhYqoMv6IER8XZ-fwyqwi9KGt4",
      authDomain: "fridge-mate-31e97.firebaseapp.com",
      projectId: "fridge-mate-31e97",
      storageBucket: "fridge-mate-31e97.firebasestorage.app",
      messagingSenderId: "543736415860",
      appId: "1:543736415860:web:312b6729c79af1221d7321"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Handle callback - This runs when Auth0 redirects back
    if (window.location.search.includes("code=") && window.location.search.includes("state=")) {
      console.log("Handling Auth0 callback...");
      loadingDiv.style.display = "block";
      signinDiv.style.display = "none";
      
      try {
        await auth0Client.handleRedirectCallback();
        console.log("Callback handled successfully");
        
        const user = await auth0Client.getUser();
        console.log("User:", user);
        
        // Check if user exists in Firestore, create if not
        const userRef = doc(db, "users", user.sub);
        const snap = await getDoc(userRef);
        
        if (!snap.exists()) {
          // User signed in but doesn't exist in Firestore (edge case)
          await setDoc(userRef, {
            email: user.email,
            name: user.name || null,
            picture: user.picture || null,
            createdAt: new Date().toISOString()
          });
          console.log("User created in Firestore");
        } else {
          console.log("Existing user found in Firestore");
        }
        
        // Redirect to dashboard
        window.location.href = "/dashboard.html";
      } catch (error) {
        console.error("Callback error:", error);
        showError("Authentication failed: " + error.message);
      }
    } else {
      // Check if already authenticated
      const isAuth = await auth0Client.isAuthenticated();
      console.log("Is authenticated:", isAuth);
      
      if (isAuth) {
        // Already logged in, go to dashboard
        window.location.href = "/dashboard.html";
      } else {
        // Setup signin button - NO screen_hint (this shows login form by default)
        document.getElementById("signinBtn").onclick = async () => {
          try {
            console.log("Initiating sign in...");
            await auth0Client.loginWithRedirect();
          } catch (error) {
            console.error("Sign in error:", error);
            showError("Failed to initiate sign in: " + error.message);
          }
        };
      }
    }
  } catch (error) {
    console.error("Initialization error:", error);
    showError("Failed to initialize: " + error.message);
  }
</script>
</body>
</html>